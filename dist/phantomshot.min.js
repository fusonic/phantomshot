var PhantomShot;!function(t){var e=function(){function t(t){this.devicePixelRatio=t.devicePixelRatio?t.devicePixelRatio:1,this.height=t.height,this.width=t.width}return t.prototype.getViewportSize=function(){return{height:this.height*this.devicePixelRatio,width:this.width*this.devicePixelRatio}},t}();t.Device=e}(PhantomShot||(PhantomShot={}));var PhantomShot;!function(t){var e=function(){function e(t){var e=this;this.filesystem=require("fs"),this.system=require("system"),this.webpage=require("webpage"),this.defaultTimeout=1e4,this.configurationPath=t,this.page=this.webpage.create(),this.page.onLoadStarted=function(){e.isLoading=!0},this.page.onLoadFinished=function(){e.isLoading=!1}}return e.prototype.run=function(t){this.finishedCallback=t,this.readConfigFile(this.configurationPath),this.configuration.login?this.loginAndTakeScreenshots():this.takeScreenshots()},e.prototype.buildFullUrl=function(t){return this.configuration.baseUrl+t},e.prototype.loginAndTakeScreenshots=function(){var t=this;this.page.open(this.buildFullUrl(this.configuration.login.url),function(i){if("success"==i){console.log("Opened login page"),e.evaluateJavaScript(t.page,t.configuration.login.inject);var o=window.setTimeout(function(){console.error("Login timed out"),t.finishedCallback(1)},t.defaultTimeout),n=window.setInterval(function(){t.isLoading||(window.clearTimeout(o),window.clearInterval(n),t.takeScreenshots())})}else console.error("Login failed"),t.finishedCallback(1)})},e.evaluateJavaScript=function(t,e){var i="phantomjs"+Math.round(1e3*Math.random())+".js",o=require("fs");o.write(i,e),t.injectJs(i),o.remove(i)},e.prototype.getDeviceById=function(e){for(var i=0;i<this.configuration.devices.length;i++)if(this.configuration.devices[i].id==e)return new t.Device(this.configuration.devices[i])},e.prototype.getTargetFilename=function(t){return this.configuration.outDir+"/"+t.id+".png"},e.prototype.takeScreenshot=function(t,i){var o=this,n=this.page,r=window.setTimeout(function(){try{n.close(),i(!1)}catch(t){}},this.defaultTimeout);n.viewportSize=t.device.getViewportSize(),n.open(t.url,function(a){if("success"==a){if(t.inject)try{e.evaluateJavaScript(n,t.inject)}catch(h){console.error("Error executing JavaScript code"),console.error(h),i(!1)}window.setTimeout(function(){try{var e=t.getTargetRectangle(n);n.clipRect=e}catch(a){console.error(a),i(!1)}n.render(o.getTargetFilename(t)),window.clearTimeout(r),i(!0)},t.delay?t.delay:0)}else i(!1)})},e.prototype.takeScreenshots=function(){var e=this,i=0,o=function(){var n=e.configuration.shots[i],r=new t.Screenshot;r.id=n.id,r.inject=n.inject,r.url=e.buildFullUrl(n.url),r.device=e.getDeviceById(n.device),r.delay=n.delay,n.element?r.element=n.element:r.region=new t.Rectangle(r.device,n.region),e.takeScreenshot(r,function(t){console.info(i+1+". "+(t?"SUCCESS":"ERROR")+": "+r.id+" ("+r.url+")"),i==e.configuration.shots.length-1?e.finishedCallback(0):(i++,o())})};o()},e.prototype.readConfigFile=function(t){console.info("Reading config from "+t);var e=this.filesystem.read(t);this.configuration=JSON.parse(e),this.configuration.timeout&&(this.defaultTimeout=1e3*this.configuration.timeout)},e}();t.PhantomShot=e}(PhantomShot||(PhantomShot={}));var PhantomShot;!function(t){var e=function(){function t(t,e){this.top=e&&e.top?e.top:0,this.left=e&&e.left?e.left:0,this.width=e&&e.width?e.width:t.width,this.height=e&&e.height?e.height:t.height}return t}();t.Rectangle=e}(PhantomShot||(PhantomShot={}));var PhantomShot;!function(t){var e=function(){function e(){}return e.prototype.getTargetRectangle=function(e){if(this.region)return this.region;t.PhantomShot.evaluateJavaScript(e,"window.phantomShotTargetElement = "+JSON.stringify(this.element)+";");var i=e.evaluate(function(){var t=document.querySelector(window.phantomShotTargetElement);if(null==t)return null;var e=t.getBoundingClientRect();return{top:e.top,left:e.left,width:e.right-e.left,height:e.bottom-e.top}});if(i)return i;throw"Target element ("+this.element+") not found."},e}();t.Screenshot=e}(PhantomShot||(PhantomShot={}));var system=require("system"),phantomShot=new PhantomShot.PhantomShot(system.args[1]);phantomShot.run(function(t){phantom.exit(t)});