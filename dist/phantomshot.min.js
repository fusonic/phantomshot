var PhantomShot;!function(t){var e=function(){function t(t){this.devicePixelRatio=t.devicePixelRatio?t.devicePixelRatio:1,this.height=t.height,this.width=t.width}return t.prototype.getViewportSize=function(){return{height:this.height*this.devicePixelRatio,width:this.width*this.devicePixelRatio}},t}();t.Device=e}(PhantomShot||(PhantomShot={}));var PhantomShot;!function(t){var e=function(){function e(t){var e=this;this.filesystem=require("fs"),this.system=require("system"),this.webpage=require("webpage"),this.configurationPath=t,this.page=this.webpage.create(),this.page.onLoadStarted=function(){e.isLoading=!0},this.page.onLoadFinished=function(){e.isLoading=!1}}return e.prototype.run=function(t){this.finishedCallback=t,this.readConfigFile(this.configurationPath),this.configuration.login?this.loginAndTakeScreenshots():this.takeScreenshots()},e.prototype.buildFullUrl=function(t){return this.configuration.baseUrl+"/"+t},e.prototype.loginAndTakeScreenshots=function(){var t=this;this.page.open(this.buildFullUrl(this.configuration.login.url),function(i){if("success"==i){console.log("Opened login page"),e.evaluateJavaScript(t.page,t.configuration.login.inject);var n=window.setTimeout(function(){window.clearInterval(o),t.takeScreenshots()},1e4),o=window.setInterval(function(){t.isLoading||(window.clearTimeout(n),window.clearInterval(o),t.takeScreenshots())})}else console.error("Login failed"),t.finishedCallback(1)})},e.evaluateJavaScript=function(t,e){var i=require("fs");i.write("tmpscript.js",e),t.injectJs("tmpscript.js"),i.remove("tmpscript.js")},e.prototype.getDeviceById=function(e){for(var i=0;i<this.configuration.devices.length;i++)if(this.configuration.devices[i].id==e)return new t.Device(this.configuration.devices[i])},e.prototype.getTargetFilename=function(t){return this.configuration.outDir+"/"+t.id+".png"},e.prototype.takeScreenshot=function(t,i){var n=this,o=this.page;o.viewportSize=t.device.getViewportSize(),o.open(t.url,function(a){if("success"==a){var r=t.getTargetRectangle(o);o.clipRect=r,t.inject&&e.evaluateJavaScript(o,t.inject),window.setTimeout(function(){o.render(n.getTargetFilename(t)),i(!0)},t.delay?t.delay:0)}else i(!1)})},e.prototype.takeScreenshots=function(){var e=this,i=0,n=function(){var o=e.configuration.shots[i],a=new t.Screenshot;a.id=o.id,a.inject=o.inject,a.url=e.buildFullUrl(o.url),a.device=e.getDeviceById(o.device),a.delay=o.delay,o.element?a.element=o.element:a.region=new t.Rectangle(a.device,o.region),e.takeScreenshot(a,function(t){console.info(i+1+". "+(t?"SUCCESS":"ERROR")+": "+a.id+" ("+a.url+")"),i==e.configuration.shots.length-1?e.finishedCallback(0):(i++,n())})};n()},e.prototype.readConfigFile=function(t){console.info("Reading config from "+t);var e=this.filesystem.read(t);this.configuration=JSON.parse(e)},e}();t.PhantomShot=e}(PhantomShot||(PhantomShot={}));var PhantomShot;!function(t){var e=function(){function t(t,e){this.top=e&&e.top?e.top:0,this.left=e&&e.left?e.left:0,this.width=e&&e.width?e.width:t.width,this.height=e&&e.height?e.height:t.height}return t}();t.Rectangle=e}(PhantomShot||(PhantomShot={}));var PhantomShot;!function(t){var e=function(){function e(){}return e.prototype.getTargetRectangle=function(e){return this.region?this.region:(t.PhantomShot.evaluateJavaScript(e,"window.phantomShotTargetElement = "+JSON.stringify(this.element)+";"),e.evaluate(function(){var t=document.querySelector(window.phantomShotTargetElement),e=t.getBoundingClientRect();return{top:e.top,left:e.left,width:e.right-e.left,height:e.bottom-e.top}}))},e}();t.Screenshot=e}(PhantomShot||(PhantomShot={}));var system=require("system"),phantomShot=new PhantomShot.PhantomShot(system.args[1]);phantomShot.run(function(t){phantom.exit(t)});