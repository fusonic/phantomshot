/// <reference path="../typings/tsd.d.ts" />
var fs = require('fs');
var system = require("system");
var webpage = require("webpage");
var page = webpage.create();
function takeScreenshot(shot, callback) {
    // Viewport
    page.viewportSize = {
        width: shot.screen.width * shot.screen.ratio,
        height: shot.screen.height * shot.screen.ratio
    };
    // Clipping
    page.clipRect = {
        top: typeof (shot.clip.top) == "undefined" ? 0 : shot.clip.top * shot.screen.ratio,
        left: typeof (shot.clip.left) == "undefined" ? 0 : shot.clip.left * shot.screen.ratio,
        width: (typeof (shot.clip.width) == "undefined" ? shot.screen.width : shot.clip.width) * shot.screen.ratio,
        height: (typeof (shot.clip.height) == "undefined" ? shot.screen.height : shot.clip.height) * shot.screen.ratio
    };
    // Open page + render
    page.open(shot.url, function (result) {
        // https://filippo.io/taking-retina-screenshots-with-phantomjs/
        if (shot.screen.ratio == 2) {
            page.evaluate(function () {
                document.body.style.webkitTransform = "scale(2)";
                document.body.style.webkitTransformOrigin = "0% 0%";
                document.body.style.width = "50%";
            });
        }
        else if (shot.screen.ratio == 3) {
            page.evaluate(function () {
                document.body.style.webkitTransform = "scale(3)";
                document.body.style.webkitTransformOrigin = "0% 0%";
                document.body.style.width = "33.3333333333%";
            });
        }
        if (result == "success") {
            window.setTimeout(function () {
                var renderResult = page.render(shot.filename);
                callback(renderResult);
            }, 1000);
        }
        else {
            callback(false);
        }
    });
}
function takeAllScreenshots(config, callback) {
    console.info("Now taking screenshots");
    var shotKeys = Object.keys(config.shots);
    var currentShot = 0;
    function processShot() {
        var thisKey = shotKeys[currentShot];
        var thisScreen = config.screens[config.shots[thisKey].screen];
        var thisClip = typeof (config.shots[thisKey].clip) == "undefined" ? {} : config.shots[thisKey].clip;
        var thisShot = {
            url: config.baseUrl + config.shots[thisKey].url,
            screen: thisScreen,
            filename: config.outDir + "/" + thisKey + "." + config.format,
            clip: thisClip
        };
        takeScreenshot(thisShot, function (result) {
            if (result) {
                console.info((currentShot + 1) + ". SUCCESS: " + thisKey + " (" + thisShot.url + ")");
            }
            else {
                console.error((currentShot + 1) + ". ERROR: " + thisKey + " (" + thisShot.url + ")");
            }
            if (currentShot == shotKeys.length - 1) {
                callback();
            }
            else {
                currentShot++;
                processShot();
            }
        });
    }
    processShot();
}
if (system.args.length !== 2) {
    console.error("Usage: phantomjs phantomshot.js [path-to-config-file]");
    phantom.exit();
}
// Read config
console.info("Reading config from " + system.args[1]);
var data = fs.read(system.args[1]);
var config = JSON.parse(data);
// Loading status
var loading = false;
page.onLoadStarted = function () {
    loading = true;
};
page.onLoadFinished = function () {
    loading = false;
};
if (typeof (config.login) == "undefined") {
    takeAllScreenshots(config, function () {
        phantom.exit();
    });
}
else {
    page.open(config.baseUrl + config.login.url, function (result) {
        console.log("Opened login page");
        page.injectJs(config.login.script);
        var interval = window.setInterval(function () {
            if (!loading) {
                window.clearInterval(interval);
                takeAllScreenshots(config, function () {
                    phantom.exit();
                });
            }
        }, 50);
    });
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvd3d3L3BoYW50b21zaG90L3BoYW50b21zaG90LnRzIl0sIm5hbWVzIjpbInRha2VTY3JlZW5zaG90IiwidGFrZUFsbFNjcmVlbnNob3RzIiwidGFrZUFsbFNjcmVlbnNob3RzLnByb2Nlc3NTaG90Il0sIm1hcHBpbmdzIjoiQUFBQSw0Q0FBNEM7QUFFNUMsSUFBSSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3ZCLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMvQixJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFFakMsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRTVCLFNBQVMsY0FBYyxDQUFDLElBQUksRUFBRSxRQUFRO0lBRWxDQSxBQUNBQSxXQURXQTtJQUNYQSxJQUFJQSxDQUFDQSxZQUFZQSxHQUFHQTtRQUNoQkEsS0FBS0EsRUFBRUEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsS0FBS0EsR0FBR0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsS0FBS0E7UUFDNUNBLE1BQU1BLEVBQUVBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLE1BQU1BLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLEtBQUtBO0tBQ2pEQSxDQUFDQTtJQUVGQSxBQUNBQSxXQURXQTtJQUNYQSxJQUFJQSxDQUFDQSxRQUFRQSxHQUFHQTtRQUNaQSxHQUFHQSxFQUFFQSxPQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxXQUFXQSxHQUFHQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxHQUFHQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxLQUFLQTtRQUNqRkEsSUFBSUEsRUFBRUEsT0FBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFB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LENBQUMsQ0FBQyxDQUFDO0lBQ3RDLGtCQUFrQixDQUFDLE1BQU0sRUFBRTtRQUN2QixPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDbkIsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBQUMsSUFBSSxDQUFDLENBQUM7SUFDSixJQUFJLENBQUMsSUFBSSxDQUNMLE1BQU0sQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQ2pDLFVBQVMsTUFBTTtRQUNYLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUNqQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFbkMsSUFBSSxRQUFRLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQztZQUM5QixFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7Z0JBQ1gsTUFBTSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDL0Isa0JBQWtCLENBQUMsTUFBTSxFQUFFO29CQUN2QixPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ25CLENBQUMsQ0FBQyxDQUFDO1lBQ1AsQ0FBQztRQUNMLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNYLENBQUMsQ0FDSixDQUFDO0FBQ04sQ0FBQyIsImZpbGUiOiJwaGFudG9tc2hvdC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi90eXBpbmdzL3RzZC5kLnRzXCIgLz5cblxudmFyIGZzID0gcmVxdWlyZSgnZnMnKTtcbnZhciBzeXN0ZW0gPSByZXF1aXJlKFwic3lzdGVtXCIpO1xudmFyIHdlYnBhZ2UgPSByZXF1aXJlKFwid2VicGFnZVwiKTtcblxudmFyIHBhZ2UgPSB3ZWJwYWdlLmNyZWF0ZSgpO1xuXG5mdW5jdGlvbiB0YWtlU2NyZWVuc2hvdChzaG90LCBjYWxsYmFjaylcbntcbiAgICAvLyBWaWV3cG9ydFxuICAgIHBhZ2Uudmlld3BvcnRTaXplID0ge1xuICAgICAgICB3aWR0aDogc2hvdC5zY3JlZW4ud2lkdGggKiBzaG90LnNjcmVlbi5yYXRpbyxcbiAgICAgICAgaGVpZ2h0OiBzaG90LnNjcmVlbi5oZWlnaHQgKiBzaG90LnNjcmVlbi5yYXRpb1xuICAgIH07XG5cbiAgICAvLyBDbGlwcGluZ1xuICAgIHBhZ2UuY2xpcFJlY3QgPSB7XG4gICAgICAgIHRvcDogdHlwZW9mKHNob3QuY2xpcC50b3ApID09IFwidW5kZWZpbmVkXCIgPyAwIDogc2hvdC5jbGlwLnRvcCAqIHNob3Quc2NyZWVuLnJhdGlvLFxuICAgICAgICBsZWZ0OiB0eXBlb2Yoc2hvdC5jbGlwLmxlZnQpID09IFwidW5kZWZpbmVkXCIgPyAwIDogc2hvdC5jbGlwLmxlZnQgKiBzaG90LnNjcmVlbi5yYXRpbyxcbiAgICAgICAgd2lkdGg6ICh0eXBlb2Yoc2hvdC5jbGlwLndpZHRoKSA9PSBcInVuZGVmaW5lZFwiID8gc2hvdC5zY3JlZW4ud2lkdGggOiBzaG90LmNsaXAud2lkdGgpICogc2hvdC5zY3JlZW4ucmF0aW8sXG4gICAgICAgIGhlaWdodDogKHR5cGVvZihzaG90LmNsaXAuaGVpZ2h0KSA9PSBcInVuZGVmaW5lZFwiID8gc2hvdC5zY3JlZW4uaGVpZ2h0IDogc2hvdC5jbGlwLmhlaWdodCkgKiBzaG90LnNjcmVlbi5yYXRpb1xuICAgIH07XG5cbiAgICAvLyBPcGVuIHBhZ2UgKyByZW5kZXJcbiAgICBwYWdlLm9wZW4oXG4gICAgICAgIHNob3QudXJsLFxuICAgICAgICBmdW5jdGlvbihyZXN1bHQpIHtcbiAgICAgICAgICAgIC8vIGh0dHBzOi8vZmlsaXBwby5pby90YWtpbmctcmV0aW5hLXNjcmVlbnNob3RzLXdpdGgtcGhhbnRvbWpzL1xuICAgICAgICAgICAgaWYgKHNob3Quc2NyZWVuLnJhdGlvID09IDIpIHtcbiAgICAgICAgICAgICAgICBwYWdlLmV2YWx1YXRlKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9IFwic2NhbGUoMilcIjtcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZS53ZWJraXRUcmFuc2Zvcm1PcmlnaW4gPSBcIjAlIDAlXCI7XG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUud2lkdGggPSBcIjUwJVwiO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChzaG90LnNjcmVlbi5yYXRpbyA9PSAzKSB7XG4gICAgICAgICAgICAgICAgcGFnZS5ldmFsdWF0ZShmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZS53ZWJraXRUcmFuc2Zvcm0gPSBcInNjYWxlKDMpXCI7XG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGUud2Via2l0VHJhbnNmb3JtT3JpZ2luID0gXCIwJSAwJVwiO1xuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LnN0eWxlLndpZHRoID0gXCIzMy4zMzMzMzMzMzMzJVwiO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocmVzdWx0ID09IFwic3VjY2Vzc1wiKSB7XG4gICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciByZW5kZXJSZXN1bHQgPSBwYWdlLnJlbmRlcihzaG90LmZpbGVuYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2socmVuZGVyUmVzdWx0KTtcbiAgICAgICAgICAgICAgICB9LCAxMDAwKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2soZmFsc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgKTtcbn1cblxuZnVuY3Rpb24gdGFrZUFsbFNjcmVlbnNob3RzKGNvbmZpZywgY2FsbGJhY2spXG57XG4gICAgY29uc29sZS5pbmZvKFwiTm93IHRha2luZyBzY3JlZW5zaG90c1wiKTtcblxuICAgIHZhciBzaG90S2V5cyA9IE9iamVjdC5rZXlzKGNvbmZpZy5zaG90cyk7XG4gICAgdmFyIGN1cnJlbnRTaG90ID0gMDtcblxuICAgIGZ1bmN0aW9uIHByb2Nlc3NTaG90KClcbiAgICB7XG4gICAgICAgIHZhciB0aGlzS2V5ID0gc2hvdEtleXNbY3VycmVudFNob3RdO1xuICAgICAgICB2YXIgdGhpc1NjcmVlbiA9IGNvbmZpZy5zY3JlZW5zW2NvbmZpZy5zaG90c1t0aGlzS2V5XS5zY3JlZW5dO1xuICAgICAgICB2YXIgdGhpc0NsaXAgPSB0eXBlb2YoY29uZmlnLnNob3RzW3RoaXNLZXldLmNsaXApID09IFwidW5kZWZpbmVkXCIgPyB7IH0gOiBjb25maWcuc2hvdHNbdGhpc0tleV0uY2xpcDtcblxuICAgICAgICB2YXIgdGhpc1Nob3QgPSB7XG4gICAgICAgICAgICB1cmw6IGNvbmZpZy5iYXNlVXJsICsgY29uZmlnLnNob3RzW3RoaXNLZXldLnVybCxcbiAgICAgICAgICAgIHNjcmVlbjogdGhpc1NjcmVlbixcbiAgICAgICAgICAgIGZpbGVuYW1lOiBjb25maWcub3V0RGlyICsgXCIvXCIgKyB0aGlzS2V5ICsgXCIuXCIgKyBjb25maWcuZm9ybWF0LFxuICAgICAgICAgICAgY2xpcDogdGhpc0NsaXBcbiAgICAgICAgfTtcblxuICAgICAgICB0YWtlU2NyZWVuc2hvdCh0aGlzU2hvdCwgZnVuY3Rpb24ocmVzdWx0KSB7XG4gICAgICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5pbmZvKChjdXJyZW50U2hvdCArIDEpICsgXCIuIFNVQ0NFU1M6IFwiICsgdGhpc0tleSArIFwiIChcIiArIHRoaXNTaG90LnVybCArIFwiKVwiKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcigoY3VycmVudFNob3QgKyAxKSArIFwiLiBFUlJPUjogXCIgKyB0aGlzS2V5ICsgXCIgKFwiICsgdGhpc1Nob3QudXJsICsgXCIpXCIpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY3VycmVudFNob3QgPT0gc2hvdEtleXMubGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRTaG90Kys7XG4gICAgICAgICAgICAgICAgcHJvY2Vzc1Nob3QoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJvY2Vzc1Nob3QoKTtcbn1cblxuaWYgKHN5c3RlbS5hcmdzLmxlbmd0aCAhPT0gMikge1xuICAgIGNvbnNvbGUuZXJyb3IoXCJVc2FnZTogcGhhbnRvbWpzIHBoYW50b21zaG90LmpzIFtwYXRoLXRvLWNvbmZpZy1maWxlXVwiKTtcbiAgICBwaGFudG9tLmV4aXQoKTtcbn1cblxuLy8gUmVhZCBjb25maWdcbmNvbnNvbGUuaW5mbyhcIlJlYWRpbmcgY29uZmlnIGZyb20gXCIgKyBzeXN0ZW0uYXJnc1sxXSk7XG52YXIgZGF0YSA9IGZzLnJlYWQoc3lzdGVtLmFyZ3NbMV0pO1xudmFyIGNvbmZpZyA9IEpTT04ucGFyc2UoZGF0YSk7XG5cbi8vIExvYWRpbmcgc3RhdHVzXG52YXIgbG9hZGluZyA9IGZhbHNlO1xucGFnZS5vbkxvYWRTdGFydGVkID0gZnVuY3Rpb24oKSB7XG4gICAgbG9hZGluZyA9IHRydWU7XG59O1xucGFnZS5vbkxvYWRGaW5pc2hlZCA9IGZ1bmN0aW9uKCkge1xuICAgIGxvYWRpbmcgPSBmYWxzZTtcbn07XG5cbmlmICh0eXBlb2YoY29uZmlnLmxvZ2luKSA9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgdGFrZUFsbFNjcmVlbnNob3RzKGNvbmZpZywgZnVuY3Rpb24oKSB7XG4gICAgICAgIHBoYW50b20uZXhpdCgpO1xuICAgIH0pO1xufSBlbHNlIHtcbiAgICBwYWdlLm9wZW4oXG4gICAgICAgIGNvbmZpZy5iYXNlVXJsICsgY29uZmlnLmxvZ2luLnVybCxcbiAgICAgICAgZnVuY3Rpb24ocmVzdWx0KSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIk9wZW5lZCBsb2dpbiBwYWdlXCIpO1xuICAgICAgICAgICAgcGFnZS5pbmplY3RKcyhjb25maWcubG9naW4uc2NyaXB0KTtcblxuICAgICAgICAgICAgdmFyIGludGVydmFsID0gd2luZG93LnNldEludGVydmFsKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIGlmICghbG9hZGluZykge1xuICAgICAgICAgICAgICAgICAgICB3aW5kb3cuY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7XG4gICAgICAgICAgICAgICAgICAgIHRha2VBbGxTY3JlZW5zaG90cyhjb25maWcsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGhhbnRvbS5leGl0KCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIDUwKTtcbiAgICAgICAgfVxuICAgICk7XG59XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=